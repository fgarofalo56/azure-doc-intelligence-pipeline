{
  "name": "Query_DeltaLake_Serverless",
  "properties": {
    "description": "SQL Serverless queries for Delta Lake Silver layer tables",
    "content": {
      "query": "-- ============================================\n-- Query Delta Lake Tables (SQL Serverless)\n-- ============================================\n\n-- Prerequisites:\n-- 1. Delta Lake tables created by DeltaLake_Medallion_Architecture notebook\n-- 2. Storage account configured with appropriate permissions\n\n-- Replace <STORAGE_ACCOUNT> with your storage account name\n\n-- ============================================\n-- OPTION 1: Create External Data Source (Recommended)\n-- ============================================\n\n-- Create database for document analytics\n/*\nCREATE DATABASE DocumentAnalytics;\nGO\nUSE DocumentAnalytics;\nGO\n\n-- Create data source for Delta Lake\nCREATE EXTERNAL DATA SOURCE DeltaLakeStorage\nWITH (\n    LOCATION = 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta'\n);\nGO\n\n-- Create file format for Delta\nCREATE EXTERNAL FILE FORMAT DeltaFormat\nWITH (\n    FORMAT_TYPE = DELTA\n);\nGO\n*/\n\n-- ============================================\n-- OPTION 2: Direct OPENROWSET Queries\n-- ============================================\n\n-- Query Silver layer documents\nSELECT TOP 100 *\nFROM OPENROWSET(\n    BULK 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta/silver/documents/',\n    FORMAT = 'DELTA'\n) AS silver_docs;\n\n-- Document summary by status and type\nSELECT \n    status,\n    document_type,\n    COUNT(*) AS document_count,\n    AVG(model_confidence) AS avg_confidence,\n    MIN(model_confidence) AS min_confidence,\n    MAX(model_confidence) AS max_confidence\nFROM OPENROWSET(\n    BULK 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta/silver/documents/',\n    FORMAT = 'DELTA'\n) AS silver_docs\nGROUP BY status, document_type\nORDER BY document_count DESC;\n\n-- Daily processing trends from Silver layer\nSELECT \n    CAST(processed_at AS DATE) AS processing_date,\n    COUNT(*) AS documents_processed,\n    SUM(CASE WHEN _is_valid = 1 THEN 1 ELSE 0 END) AS successful,\n    SUM(CASE WHEN _is_valid = 0 THEN 1 ELSE 0 END) AS failed,\n    AVG(model_confidence) AS avg_confidence\nFROM OPENROWSET(\n    BULK 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta/silver/documents/',\n    FORMAT = 'DELTA'\n) AS silver_docs\nWHERE processed_at IS NOT NULL\nGROUP BY CAST(processed_at AS DATE)\nORDER BY processing_date DESC;\n\n-- Model performance from Silver layer\nSELECT \n    model_id,\n    COUNT(*) AS total_documents,\n    AVG(model_confidence) AS avg_confidence,\n    SUM(CASE WHEN model_confidence >= 0.9 THEN 1 ELSE 0 END) AS high_confidence,\n    SUM(CASE WHEN model_confidence < 0.8 THEN 1 ELSE 0 END) AS low_confidence,\n    CAST(SUM(CASE WHEN model_confidence >= 0.9 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) AS DECIMAL(5,1)) AS high_confidence_pct\nFROM OPENROWSET(\n    BULK 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta/silver/documents/',\n    FORMAT = 'DELTA'\n) AS silver_docs\nWHERE _is_valid = 1\nGROUP BY model_id\nORDER BY total_documents DESC;\n\n-- ============================================\n-- Create External Table (for easier querying)\n-- ============================================\n\n/*\nUSE DocumentAnalytics;\nGO\n\nCREATE EXTERNAL TABLE silver_documents (\n    document_id VARCHAR(500),\n    source_file VARCHAR(1000),\n    processed_at DATETIME2,\n    status VARCHAR(50),\n    error_message VARCHAR(MAX),\n    model_id VARCHAR(200),\n    model_confidence FLOAT,\n    document_type VARCHAR(100),\n    extracted_fields_json VARCHAR(MAX),\n    field_confidence_json VARCHAR(MAX),\n    _bronze_ingested_at DATETIME2,\n    _bronze_source VARCHAR(100),\n    _silver_transformed_at DATETIME2,\n    _is_valid BIT\n)\nWITH (\n    LOCATION = 'silver/documents/',\n    DATA_SOURCE = DeltaLakeStorage,\n    FILE_FORMAT = DeltaFormat\n);\nGO\n\n-- Now you can query like a regular table\nSELECT * FROM silver_documents WHERE _is_valid = 1;\n*/\n\n-- ============================================\n-- Compare Bronze vs Silver counts\n-- ============================================\n\nSELECT 'Bronze' AS layer, COUNT(*) AS record_count\nFROM OPENROWSET(\n    BULK 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta/bronze/extracted_documents/',\n    FORMAT = 'DELTA'\n) AS bronze\nUNION ALL\nSELECT 'Silver' AS layer, COUNT(*) AS record_count\nFROM OPENROWSET(\n    BULK 'https://<STORAGE_ACCOUNT>.dfs.core.windows.net/delta/silver/documents/',\n    FORMAT = 'DELTA'\n) AS silver;",
      "metadata": {
        "language": "sql"
      },
      "currentConnection": {
        "databaseName": "master",
        "poolName": "Built-in"
      }
    },
    "type": "SqlQuery",
    "folder": {
      "name": "DocumentProcessing/Analytics"
    }
  }
}
