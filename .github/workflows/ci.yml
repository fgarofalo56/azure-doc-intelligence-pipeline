name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'notebooks/**'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to Azure'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'src/functions'

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Ruff linter
        run: uv run ruff check src/ tests/ --output-format=github

      - name: Run Ruff formatter check
        run: uv run ruff format --check src/ tests/

      - name: Run MyPy type checker
        run: uv run mypy src/functions/ --ignore-missing-imports

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: uv pip install bandit[toml]

      - name: Run Bandit security scanner
        run: |
          uv run bandit -r src/functions/ \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium \
            -x "**/tests/**,**/.venv/**" || true

      - name: Display Bandit results
        run: |
          if [ -f bandit-report.json ]; then
            echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat bandit-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
        if: always()

      - name: Check for high severity issues
        run: |
          uv run bandit -r src/functions/ \
            --severity-level high \
            --confidence-level high \
            -x "**/tests/**,**/.venv/**"

  lint-bicep:
    name: Lint Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bicep
        uses: anthony-c-martin/setup-bicep@v1

      - name: Lint Bicep files
        run: |
          for file in $(find infra -name "*.bicep"); do
            echo "Linting $file..."
            bicep build "$file" --stdout > /dev/null
          done

      - name: Validate main.bicep
        run: bicep build infra/main.bicep --stdout > /dev/null

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run unit tests with coverage
        run: |
          uv run pytest tests/unit/ -v \
            --cov=src/functions \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=70

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: integration
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run integration tests
        env:
          DOC_INTEL_ENDPOINT: ${{ secrets.DOC_INTEL_ENDPOINT }}
          DOC_INTEL_API_KEY: ${{ secrets.DOC_INTEL_API_KEY }}
          COSMOS_ENDPOINT: ${{ secrets.COSMOS_ENDPOINT }}
          COSMOS_DATABASE: ${{ secrets.COSMOS_DATABASE }}
          COSMOS_CONTAINER: ${{ secrets.COSMOS_CONTAINER }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          uv run pytest tests/integration/ -v --run-integration
        continue-on-error: true

  build:
    name: Build Function Package
    runs-on: ubuntu-latest
    needs: [test, lint-bicep, security]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"

      - name: Upload function artifact
        uses: actions/upload-artifact@v4
        with:
          name: function-app
          path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Download function artifact
        uses: actions/download-artifact@v4
        with:
          name: function-app
          path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          scm-do-build-during-deployment: true
          enable-oryx-build: true

      - name: Logout from Azure
        run: az logout
        if: always()

  deploy-infrastructure:
    name: Deploy Infrastructure (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: infrastructure
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ vars.AZURE_REGION || 'eastus' }}
          template: infra/main.bicep
          parameters: infra/parameters/dev.bicepparam
          failOnStdErr: false

      - name: Logout from Azure
        run: az logout
        if: always()
